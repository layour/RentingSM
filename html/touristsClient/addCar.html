<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
	<meta charset="UTF-8">
	<title>添加车辆</title>
	<link rel="stylesheet" href="../../css/iuapmobile.um.css">
	<link rel="stylesheet" href="../../css/fonts/iconfont.css">
	<link rel="stylesheet" href="../../css/mint.css">
	<link rel="stylesheet" href="./car.min.css">
	<script src="../../js/summer.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/font.js"></script>
	<script src="../../js/vue.js"></script>
	<script src="../../js/mint.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/Frameworks/iuapmobile.frameworks.ui.js"></script>
</head>

<body>
	<div class="um-win" id="addCar" v-cloak>
		<div class="um-content addCar">
			<table>
				<tr>
					<td>经销商</td>
					<td>
						<span>{{dealer}}</span>
					</td>
				</tr>
				<tr @click="surePickerOldCar">
					<td>是否二手车</td>
					<td>
						<span v-if='isOldCar'>{{isOldCar}}</span>
						<span class="grayColor" v-else>请选择</span>
						<i class="icon iconfont icon-enter"></i>
					</td>
				</tr>
				<tr @click="surePickerColor">
					<td>品牌类型</td>
					<td>
						<span v-if='color'>{{color}}</span>
						<span class="grayColor" v-else>请选择</span>
						<i class="icon iconfont icon-enter"></i>
					</td>
				</tr>
				<tr @click="pickerModels">
					<td>选择车型</td>
					<td>
						<span v-if='carModels'>{{carModels}}</span>
						<span class="grayColor" v-else>请选择</span>
						<i class="icon iconfont icon-enter"></i>
					</td>
				</tr>
				<template v-if="isOldCar=='是'">
					<tr>
						<td>车辆识别号</td>
						<td class='oldCar'>
							<input type="text" name="carNumber" placeholder="请输入车辆识别号" v-model="carNumber">
						</td>
					</tr>
					<tr>
						<td>发动机号</td>
						<td class='oldCar'>
							<input type="text" name="powerNumber" placeholder="请输入发动机号" v-model="powerNumber">
						</td>
					</tr>
					<tr>
						<td>二手车里程数(公里)</td>
						<td class='oldCar'>
							<input type="text" name="mileage" placeholder="二手车里程数(公里)" v-model="mileage">
						</td>
					</tr>
					<tr>
						<td>二手车首次登记日期</td>
						<td class='oldCar'>
							<input type="text" name="firstDate" placeholder="二手车首次登记日期" v-model="firstDate">
						</td>
					</tr>
					<tr @click="pickerDealCity">
						<td>交易城市</td>
						<td class='oldCar lastCity'>
							<span v-if='dealCity'>{{dealCity}}</span>
							<span class="grayColor" v-else>请选择</span>
							<i class="icon iconfont icon-enter"></i>
						</td>
					</tr>
					<tr>
						<td>卖家姓名</td>
						<td class='oldCar'>
							<input type="text" name="customerName" placeholder="请输入卖家姓名" v-model="customerName">
						</td>
					</tr>
					<tr>
						<td>卖家证件号码</td>
						<td class='oldCar'>
							<input type="text" name="carId" placeholder="请输入卖家证件号码" v-model="carId">
						</td>
					</tr>
				</template>
				<tr>
					<td>车辆单价</td>
					<td class='last'>
						<input type="text" @input="checkNumber($event,'realityPrice')" name="price" placeholder="请输入车辆单价" v-model="realityPrice">元
					</td>
				</tr>
				<tr>
					<td>车身颜色</td>
					<td>
						<input type="text"  name="carColor" placeholder="请输入车身颜色" v-model="carColor">
					</td>
				</tr>
			</table>
			<mt-popup v-model="pickerColorStatus" position='bottom' class="pickerColor">
				<mt-picker value-key="label" :slots="slots" @change="onValuesChange"></mt-picker>
				<p>
					<span class="" @click="surePickerColor">取消</span>
					<span class="" @click="surePickerColor('confirm')">确定</span>
				</p>
			</mt-popup>
			<mt-popup v-model="pickerOldCarStatus" position='bottom' class="pickerColor">
				<mt-picker :slots="slots1" @change="onOldCarChange"></mt-picker>
				<p>
					<span class="" @click="surePickerOldCar">取消</span>
					<span class="" @click="surePickerOldCar('confirm')">确定</span>
				</p>
			</mt-popup>
		</div>
	</div>
	<script>
		summerready = function () {
			addCar.PROJECT_ID=summer.pageParam.id
			console.log("PROJECT_ID",addCar.PROJECT_ID);
			addCar.getData()
		}
		var addCar = new Vue({
			el: '#addCar',
			data() {
				return {
					dealer: '',
					dealerId:'',
					carStatus: 'new',
					braNm:'',
					equNm:'',
					equSet:'',
					equMdl:'',
					carModels: '',
					color: '',
					carColor:'',
					realityPrice: '',
					pickerColorStatus: false,
					pickerOldCarStatus: false,
					pickedColor: '',
					pickedOldCar: '',
					isOldCar: '',
					carNumber: '',
					powerNumber: '',
					mileage: '',
					firstDate: '',
					dealCity: '',
					rgnReCd:{},
					rgnPrCd:{},
					rgnCyCd:{},
					rgnToCd:{},
					customerName: '',
					carId: '',
					id: '',
					PROJECT_ID: '',
					transParam:[],
					regionArray:[],
					slots: [{
						flex: 1,
						values: [],
						defaultIndex: 0,
						className: 'slot1',
						textAlign: 'center'
					}],
					slots1: [{
						flex: 1,
						values: ["是", "否"],
						defaultIndex: 0,
						className: 'slot1',
						textAlign: 'center'
					}]
				}
			},
			created() {},
			methods: {
				getData() {
					var _this = this;
					ajaxRequest({
						type: 'GET',
						url: 'appservice/project/prjprdbscinfo/toAddPrd.do',
						param: {
							id:_this.PROJECT_ID
						}
					}, function (res) {
						console.log("返回数据",JSON.stringify(res.data.datas.prjBscInfo.prjEquBscInfo),JSON.stringify(res.data.datas.prjBscInfo.prjEqiDtlCar));
						_this.slots[0].values = res.data.datas.braTypeList
						_this.transParam=res.data.datas.braList
						_this.regionArray=res.data.datas.regionArray
						_this.dealer=res.data.datas.prjBscInfo.splBscInfo.splNm
						var resData=res.data.datas.prjBscInfo.prjEquBscInfo;
						if(resData){
							_this.isOldCar=resData.isNew=='1'?"是":"否"
							_this.colorId=resData.braTypCd
							for(var i=0;i<res.data.datas.braTypeList.length;i++){
								if(res.data.datas.braTypeList[i].value==resData.braTypCd){
									_this.color=res.data.datas.braTypeList[i].label
								}
							}
							_this.braNm=resData.braNm
							_this.equNm=resData.equNm
							_this.equSet=resData.equSet
							_this.equMdl=resData.equMdl
							_this.carModels=resData.equNm
							_this.realityPrice=resData.equAmt
							var oldCarData=res.data.datas.prjBscInfo.prjEqiDtlCar
							_this.carColor=oldCarData.carCl
							if(resData.isNew=='1'){
								_this.carNumber=oldCarData.vinNo
								_this.powerNumber=oldCarData.engNo
								_this.mileage=oldCarData.usedCarMil
								_this.firstDate=oldCarData.usedCarReg
								_this.dealCity=oldCarData.rgnReCd.name+oldCarData.rgnPrCd.name+oldCarData.rgnCyCd.name+oldCarData.rgnToCd.name
								_this.customerName=oldCarData.sellerNm
								_this.carId=oldCarData.idCardNo
								_this.rgnReCd=oldCarData.rgnReCd
								_this.rgnPrCd=oldCarData.rgnPrCd
								_this.rgnCyCd=oldCarData.rgnCyCd
								_this.rgnToCd=oldCarData.rgnToCd
							}
						}
					}, function (err) {
						console.log("err", JSON.stringify(err));
					})
				},
				checkNumber(e, param) {
					var val = $(e.currentTarget).val()
					if (!/^([1-9]\d{0,9}|0)([.]?|(\.\d{1,2})?)$/.test(val)) {
						if (param == 'guidePrice') {
							this.guidePrice = ''
						} else if (param == 'realityPrice') {
							this.realityPrice = ''
						} else if (param == 'onePrice') {
							this.onePrice = ''
						} else if (param == 'safePrice') {
							this.safePrice = ''
						}
					}
				},
				pickerDealCity(){
					var _this=this
						summer.openWin({
							id: 'pickerDealCity',
							url: 'html/touristsClient/pickerDealCity.html',
							create: false,
							type: 'actionBar',
							pageParam: {
								list: JSON.stringify(_this.regionArray)
							},
							actionBar: {
								title: "选择大区",
								titleColor: "#ffffff",
								backgroundColor: "#039BE5",
								leftItem: {
									image: "img/back.png",
									method: '',
									text: "返回",
									textColor: "#ffffff"
								}
							}
						})
				},
				pickerModels() {
					var _this=this
						summer.openWin({
							id: 'pickerModels',
							url: 'html/touristsClient/pickerModels.html',
							create: false,
							type: 'actionBar',
							pageParam: {
								list: JSON.stringify(_this.transParam)
							},
							actionBar: {
								title: "选择品牌",
								titleColor: "#ffffff",
								backgroundColor: "#039BE5",
								leftItem: {
									image: "img/back.png",
									method: '',
									text: "返回",
									textColor: "#ffffff"
								}
							}
						})
				},
				onValuesChange(picker, values) {
					this.pickedColor = values[0];
				},
				onOldCarChange(picker, values) {
					this.pickedOldCar = values[0]
				},
				surePickerColor(param) {
					this.pickerColorStatus = !this.pickerColorStatus;
					if (param == 'confirm') {
						this.color = this.pickedColor.label;
						this.colorId = this.pickedColor.value;
						if(this.color=="二手车"){
							this.isOldCar="是"
						}else {
							this.isOldCar="否"
						}
					}
				},
				surePickerOldCar(param) {
					this.pickerOldCarStatus = !this.pickerOldCarStatus;
					if (param == 'confirm') {
						this.isOldCar = this.pickedOldCar
						if(this.isOldCar=="是"){
							this.color = "二手车";
							this.colorId = "6";
						}
					}
				},
				save() {
					var _this=this
					if (!this.dealer  || !this.isOldCar||!this.color || !this.carModels ||!this.carColor|| this.realityPrice == '') {
						summer.toast({
							msg: '请填写车辆的所有信息'
						})
						return
					}
					if(this.isOldCar=="是"){
						if (!this.carNumber  || !this.powerNumber||!this.mileage || !this.firstDate ||!this.customerName|| !this.carId||!this.dealCity) {
							summer.toast({
								msg: '请填写车辆的所有信息'
							})
							return
						}
					}
					var prjEquBscInfo = {},prjEqiDtlCar={};
					summer.showProgress();
					prjEquBscInfo.isNew=this.isOldCar=="是"?1:2;
					prjEquBscInfo.braTypCd=this.colorId

					prjEquBscInfo.braNm=this.braNm
					prjEquBscInfo.equSet=this.equSet
					prjEquBscInfo.equMdl=this.equMdl
					prjEquBscInfo.equNm=this.equNm
					prjEquBscInfo.equAmt= this.realityPrice;
					prjEqiDtlCar.carCl=this.carColor
					prjEquBscInfo.equQty="1"
					if(this.isOldCar=="是"){
						prjEqiDtlCar.vinNo=this.carNumber
						prjEqiDtlCar.engNo=this.powerNumber
						prjEqiDtlCar.usedCarMil=this.mileage
						prjEqiDtlCar.usedCarReg=this.firstDate
						prjEqiDtlCar.sellerNm=this.customerName
						prjEqiDtlCar.idCardNo=this.carId
						prjEqiDtlCar.rgnReCd=this.rgnReCd
						prjEqiDtlCar.rgnPrCd=this.rgnPrCd
						prjEqiDtlCar.rgnCyCd=this.rgnCyCd
						prjEqiDtlCar.rgnToCd=this.rgnToCd
					}
					console.log("param", JSON.stringify({
							prjEquBscInfo:prjEquBscInfo,
							prjEqiDtlCar:prjEqiDtlCar,
							id:_this.PROJECT_ID
					}));
					ajaxRequest({
						type:"GET",
						url:'appservice/project/prjprdbscinfo/add.do',
						param:{
								prjEquBscInfo:prjEquBscInfo,
								prjEqiDtlCar:prjEqiDtlCar,
								id:_this.PROJECT_ID
						}
					},function(res){
						console.log("返回数据",JSON.stringify(res));
						summer.hideProgress();
						summer.toast({msg:"保存成功"});
						summer.execScript({
								winId: "setProject",
								script: "addRight('addCarList')"
						});
						summer.closeWin()
					},function(err){
						console.log("err", JSON.stringify(err));
					})

				}
			}
		});

		function getModels() {
			var models = summer.getStorage('pickerModels4');
			console.log(summer.getStorage('pickerModels1'), summer.getStorage('pickerModels2'),summer.getStorage('pickerModels3'), models);
			if (models) {
				addCar.carModels =models
				addCar.braNm=summer.getStorage('pickerModels1')
				addCar.equSet=summer.getStorage('pickerModels2')
				addCar.equMdl=summer.getStorage('pickerModels3')
				addCar.equNm=models
				addCar.realityPrice = summer.getStorage('realityPrice')
			}
		}
		function getCity() {
			addCar.rgnReCd=JSON.parse(summer.getStorage("pickerDealCity1"))
			addCar.rgnPrCd=JSON.parse(summer.getStorage("pickerDealCity2"))
			addCar.rgnCyCd=JSON.parse(summer.getStorage("pickerDealCity3"))
			addCar.rgnToCd=JSON.parse(summer.getStorage("pickerDealCity4"))
			addCar.dealCity=addCar.rgnReCd.name+addCar.rgnPrCd.name+addCar.rgnCyCd.name+addCar.rgnToCd.name
		}
		function goBack() {
			addCar.save()
		}
	</script>
</body>

</html>
